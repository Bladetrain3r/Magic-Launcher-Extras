<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLEconomy - It Just Works</title>
    <!-- Tailwind CSS CDN for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to blend with Tailwind and maintain retro theme */
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            margin: 0;
            /* Subtle background pattern */
            background-image:
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    #001100 1px,
                    #001100 2px
                );
        }

        h1, h3 {
            color: #0f0;
            text-align: center;
            text-shadow: 0 0 10px #0f0;
            margin: 10px 0;
        }

        .subtitle {
            text-align: center;
            color: #080;
            font-size: 0.75rem; /* responsive text size */
            margin-bottom: 20px;
        }

        .market, .agents, .player {
            border: 1px solid #0f0;
            padding: 15px;
            margin-bottom: 20px;
            background: #001100;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3); /* Green glow */
        }

        .player {
            border: 2px solid #ff0;
            background: #111100;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.3); /* Yellow glow */
        }

        .good {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px;
            background: #000;
            border: 1px solid #030;
            border-radius: 4px;
        }

        .good-name {
            color: #0f0;
            font-weight: bold;
            width: 80px;
        }

        .price {
            color: #ff0;
            width: 80px;
            text-align: right;
        }

        .arrow-up { color: #0f0; }
        .arrow-down { color: #f00; }
        .arrow-flat { color: #888; }

        .supply-demand {
            color: #080;
            font-size: 0.7rem; /* responsive text size */
            text-align: right;
        }

        .agent {
            margin: 5px 0;
            color: #0a0;
            font-size: 0.875rem; /* responsive text size */
        }

        .inventory {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 20px;
            margin-top: 10px;
        }

        .inv-item {
            color: #ff0;
        }

        .controls {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        button {
            background: #001100;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 20px;
            font-family: inherit;
            cursor: pointer;
            font-size: 0.875rem; /* responsive text size */
            border-radius: 6px; /* Rounded corners */
            transition: all 0.2s ease-in-out; /* Smooth transitions */
            box-shadow: 0 2px 5px rgba(0, 255, 0, 0.2); /* Subtle shadow */
        }

        button:hover {
            background: #003300;
            box-shadow: 0 0 15px #0f0, 0 0 20px rgba(0, 255, 0, 0.5); /* Enhanced glow on hover */
            transform: translateY(-2px); /* Slight lift */
        }

        /* Modals - general styling */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            z-index: 100;
            box-shadow: 0 0 30px #0f0;
            border-radius: 10px; /* Rounded corners for modals */
            max-width: 90%; /* Responsive width */
            width: 350px; /* Fixed width for larger screens */
        }

        .modal input, .modal select {
            background: #001100;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px; /* Increased padding for better touch targets */
            font-family: inherit;
            width: calc(100% - 18px); /* Adjust width for padding/border */
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .modal select {
            width: 100%; /* Full width for select */
        }

        .modal button {
            margin-top: 10px;
            width: 48%; /* Adjust button width within modal */
        }
        .modal button:first-of-type {
            margin-right: 4%; /* Space between buttons */
        }

        .trend {
            color: #ff0;
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            opacity: 0.8;
            font-size: 0.9rem; /* responsive text size */
        }

        .tick {
            text-align: center;
            color: #080;
            margin-bottom: 10px;
            font-size: 1.125rem; /* responsive text size */
        }

        /* Message Modal specific styles */
        #messageModal p {
            margin-bottom: 15px;
            text-align: center;
        }
        #messageModal button {
            width: 100%;
            margin-right: 0;
        }

        /* Responsive adjustments */
        @media (min-width: 640px) {
            h1 {
                font-size: 3rem; /* Larger on desktop */
            }
            .subtitle {
                font-size: 0.875rem;
            }
            .market, .agents, .player {
                padding: 20px;
            }
            .tick {
                font-size: 1.25rem;
            }
            .good-name {
                width: 100px;
            }
            .price {
                width: 100px;
            }
            .supply-demand {
                font-size: 0.875rem;
            }
            .agent {
                font-size: 1rem;
            }
            button {
                font-size: 1rem;
            }
            .trend {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="bg-black text-green-500">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl sm:text-5xl font-bold text-center mb-4 leading-tight">MLECONOMY v0.1</h1>
        <div class="subtitle text-sm sm:text-base">"Working economy in 200 lines - Unlike Some $700M Projects"</div>
        
        <div class="tick">TICK: <span id="tick">0</span></div>
        
        <div class="market">
            <h3 class="text-green-400 text-xl sm:text-2xl mt-0 mb-4">MARKET STATUS</h3>
            <div id="market-display"></div>
        </div>
        
        <div class="agents">
            <h3 class="text-green-400 text-xl sm:text-2xl mt-0 mb-4">ECONOMIC AGENTS</h3>
            <div id="agents-display"></div>
        </div>
        
        <div class="player">
            <h3 class="text-yellow-400 text-xl sm:text-2xl mt-0 mb-4">YOUR ASSETS</h3>
            <div class="text-lg sm:text-xl mb-2">Cash: $<span id="cash">1000.00</span></div>
            <div class="inventory">
                <div class="text-yellow-400 mr-2">Inventory:</div>
                <div id="inventory" class="flex flex-wrap gap-x-4"></div>
            </div>
        </div>
        
        <div class="trend" id="trend">Market is finding equilibrium...</div>
        
        <div class="controls">
            <button onclick="showBuyModal()">BUY</button>
            <button onclick="showSellModal()">SELL</button>
            <button onclick="wait()">WAIT</button>
            <button onclick="togglePause()" id="pauseBtn">PAUSE</button>
        </div>
        
        <!-- Buy Modal -->
        <div class="modal" id="buyModal">
            <h3 class="text-green-400 text-xl mb-4">BUY GOODS</h3>
            <select id="buyGood" class="w-full bg-green-900 text-green-300 border border-green-500 p-2 rounded mb-4">
                <option value="FOOD">FOOD</option>
                <option value="METAL">METAL</option>
                <option value="ENERGY">ENERGY</option>
                <option value="LUXURY">LUXURY</option>
            </select>
            <input type="number" id="buyAmount" placeholder="Amount" min="1" class="w-full bg-green-900 text-green-300 border border-green-500 p-2 rounded mb-4">
            <div class="flex justify-between gap-2">
                <button onclick="executeBuy()" class="flex-1">CONFIRM</button>
                <button onclick="closeModals()" class="flex-1">CANCEL</button>
            </div>
        </div>
        
        <!-- Sell Modal -->
        <div class="modal" id="sellModal">
            <h3 class="text-green-400 text-xl mb-4">SELL GOODS</h3>
            <select id="sellGood" class="w-full bg-green-900 text-green-300 border border-green-500 p-2 rounded mb-4">
                <option value="FOOD">FOOD</option>
                <option value="METAL">METAL</option>
                <option value="ENERGY">ENERGY</option>
                <option value="LUXURY">LUXURY</option>
            </select>
            <input type="number" id="sellAmount" placeholder="Amount" min="1" class="w-full bg-green-900 text-green-300 border border-green-500 p-2 rounded mb-4">
            <div class="flex justify-between gap-2">
                <button onclick="executeSell()" class="flex-1">CONFIRM</button>
                <button onclick="closeModals()" class="flex-1">CANCEL</button>
            </div>
        </div>

        <!-- Message Modal (Replaces Alerts) -->
        <div class="modal" id="messageModal">
            <h3 class="text-yellow-400 text-xl mb-4 text-center">MESSAGE</h3>
            <p id="messageContent" class="text-center mb-6"></p>
            <button onclick="closeModals()" class="w-full">OK</button>
        </div>
    </div>

    <script>
        // MLEconomy - A working economy simulator
        // Chris Roberts: $700M, 12 years, broken economy
        // Us: 200 lines, 1 afternoon, actually works
        
        class Economy {
            constructor() {
                // Define the goods available in the economy
                this.goods = {
                    'FOOD': {
                        supply: 100,
                        demand: 100,
                        price: 10.0,
                        basePrice: 10.0,
                        volatility: 0.08,  // Controls how quickly price adjusts to supply/demand
                        history: []       // Stores past prices for trend analysis (though not fully utilized in UI)
                    },
                    'METAL': {
                        supply: 50,
                        demand: 80,
                        price: 20.0,
                        basePrice: 20.0,
                        volatility: 0.10,
                        history: []
                    },
                    'ENERGY': {
                        supply: 200,
                        demand: 150,
                        price: 5.0,
                        basePrice: 5.0,
                        volatility: 0.05,  // Most stable good
                        history: []
                    },
                    'LUXURY': {
                        supply: 10,
                        demand: 50,
                        price: 100.0,
                        basePrice: 100.0,
                        volatility: 0.15,  // Most volatile good
                        history: []
                    }
                };
                
                // Define simple economic agents (producers/consumers)
                this.agents = [
                    {name: 'FARMER', produces: 'FOOD', amount: 8, consumes: 'ENERGY', needs: 2, efficiency: 1.0},
                    {name: 'MINER', produces: 'METAL', amount: 4, consumes: 'FOOD', needs: 3, efficiency: 1.0},
                    {name: 'PLANT', produces: 'ENERGY', amount: 15, consumes: 'METAL', needs: 1, efficiency: 1.0},
                    {name: 'ARTISAN', produces: 'LUXURY', amount: 1, consumes: 'METAL', needs: 2, efficiency: 1.0}
                ];
                
                // Initialize player's starting cash and empty inventory
                this.playerCash = 1000;
                this.playerInventory = {
                    'FOOD': 0,
                    'METAL': 0,
                    'ENERGY': 0,
                    'LUXURY': 0
                };
                
                this.tick = 0;      // Tracks the simulation's progression
                this.paused = false; // Controls simulation auto-advance
            }
            
            /**
             * Advances the economy by one tick.
             * Agents produce/consume, and prices adjust based on supply/demand.
             */
            simulateTick() {
                if (this.paused) return; // Do nothing if paused
                
                this.tick++; // Increment tick counter
                
                // Store current prices to compare for price change arrows in display
                for (let name in this.goods) {
                    this.goods[name].prevPrice = this.goods[name].price;
                }
                
                // Agents simulate their production and consumption cycles
                for (let agent of this.agents) {
                    // Production: agent produces 'produces' good with some random variation
                    let production = agent.amount * agent.efficiency * (0.9 + Math.random() * 0.2);
                    this.goods[agent.produces].supply += production;
                    
                    // Consumption: agent consumes 'consumes' good with some random variation
                    let consumption = agent.needs * (0.9 + Math.random() * 0.2);
                    // Ensure agent doesn't consume more than available supply
                    let consumed = Math.min(consumption, this.goods[agent.consumes].supply);
                    this.goods[agent.consumes].supply -= consumed;
                    this.goods[agent.consumes].demand += consumption; // Consumption adds to demand
                    
                    // Agent efficiency adjusts based on whether their needs were met
                    if (consumed < agent.needs * 0.8) {
                        agent.efficiency *= 0.98;  // Decline if not enough supplies
                    } else {
                        agent.efficiency = Math.min(1.2, agent.efficiency * 1.02); // Improve up to a cap
                    }
                }
                
                // Adjust prices based on supply and demand for each good
                for (let name in this.goods) {
                    let good = this.goods[name];
                    
                    // Calculate supply/demand ratio to determine price pressure
                    let ratio = good.demand / Math.max(good.supply, 1); // Avoid division by zero
                    
                    // Target price: using sqrt to make price changes less aggressive
                    let targetPrice = good.basePrice * Math.sqrt(ratio);
                    
                    // Smooth adjustment: move current price towards target price based on volatility
                    let adjustment = (targetPrice - good.price) * good.volatility;
                    
                    // Apply adjustment with a damping factor (0.5) to keep changes gentle and avoid oscillation
                    good.price = Math.max(0.1, good.price + adjustment * 0.5); // Prices cannot go below 0.1
                    
                    // Natural decay: demand and supply slowly return towards a baseline
                    good.demand *= 0.95;  // Demand slowly decreases
                    good.demand += 20;    // Add base demand to keep market active
                    good.supply *= 0.98;  // Supply slowly decreases
                    
                    // Store price history (for potential future charts/analysis)
                    good.history.push(good.price);
                    if (good.history.length > 50) good.history.shift(); // Keep history to last 50 ticks
                }
                
                this.updateDisplay();   // Refresh the UI
                this.detectTrends();    // Update market trend messages
            }
            
            /**
             * Detects and displays market trends (shortages/oversupply).
             */
            detectTrends() {
                let trends = [];
                
                for (let name in this.goods) {
                    let good = this.goods[name];
                    // If supply is less than half of demand, a shortage is developing
                    if (good.supply < good.demand * 0.5) {
                        trends.push(`${name} shortage developing...`);
                    // If supply is more than double the demand, oversupply is occurring
                    } else if (good.supply > good.demand * 2) {
                        trends.push(`${name} oversupply, prices falling...`);
                    }
                }
                
                // Update the trend display with the first detected trend, or default message
                if (trends.length > 0) {
                    document.getElementById('trend').textContent = trends[0];
                } else {
                    document.getElementById('trend').textContent = 'Market is finding equilibrium...';
                }
            }
            
            /**
             * Handles player's buy action.
             * @param {string} goodName - The name of the good to buy.
             * @param {number} amount - The quantity to buy.
             * @returns {boolean} True if transaction successful, false otherwise.
             */
            buy(goodName, amount) {
                const good = this.goods[goodName];
                const cost = good.price * amount;
                
                // Check if player has enough cash and if enough supply is available
                if (this.playerCash >= cost && good.supply >= amount) {
                    this.playerCash -= cost;
                    this.playerInventory[goodName] += amount;
                    good.supply -= amount; // Reduce market supply
                    good.demand += amount * 0.5; // Player buying slightly increases demand
                    this.updateDisplay();
                    return true;
                }
                return false; // Transaction failed
            }
            
            /**
             * Handles player's sell action.
             * @param {string} goodName - The name of the good to sell.
             * @param {number} amount - The quantity to sell.
             * @returns {boolean} True if transaction successful, false otherwise.
             */
            sell(goodName, amount) {
                // Check if player has enough of the good in inventory
                if (this.playerInventory[goodName] >= amount) {
                    const good = this.goods[goodName];
                    // Apply a small transaction cost (5% less revenue)
                    const revenue = good.price * amount * 0.95; 
                    
                    this.playerCash += revenue;
                    this.playerInventory[goodName] -= amount;
                    good.supply += amount; // Increase market supply
                    good.demand -= amount * 0.2; // Player selling slightly decreases demand
                    this.updateDisplay();
                    return true;
                }
                return false; // Transaction failed
            }
            
            /**
             * Updates all relevant UI elements to reflect the current economy state.
             */
            updateDisplay() {
                // Update simulation tick counter
                document.getElementById('tick').textContent = this.tick;
                
                // Update market prices, supply, demand, and price change arrows
                let marketHTML = '';
                for (let name in this.goods) {
                    let good = this.goods[name];
                    let arrow = '→'; // Default: no change
                    let arrowClass = 'arrow-flat';
                    
                    if (good.prevPrice) { // Only show arrows if there's a previous price to compare
                        if (good.price > good.prevPrice * 1.01) { // Price increased by more than 1%
                            arrow = '↑';
                            arrowClass = 'arrow-up';
                        } else if (good.price < good.prevPrice * 0.99) { // Price decreased by more than 1%
                            arrow = '↓';
                            arrowClass = 'arrow-down';
                        }
                    }
                    
                    marketHTML += `
                        <div class="good">
                            <span class="good-name">${name}</span>
                            <span class="price">$${good.price.toFixed(2)} <span class="${arrowClass}">${arrow}</span></span>
                            <span class="supply-demand">S:${good.supply.toFixed(0)} D:${good.demand.toFixed(0)}</span>
                        </div>
                    `;
                }
                document.getElementById('market-display').innerHTML = marketHTML;
                
                // Update economic agents' display (production, consumption, efficiency)
                let agentsHTML = '';
                for (let agent of this.agents) {
                    let efficiency = (agent.efficiency * 100).toFixed(0);
                    agentsHTML += `
                        <div class="agent">
                            ${agent.name}: +${(agent.amount * agent.efficiency).toFixed(1)} ${agent.produces} | 
                            -${agent.needs} ${agent.consumes} | 
                            Eff: ${efficiency}%
                        </div>
                    `;
                }
                document.getElementById('agents-display').innerHTML = agentsHTML;
                
                // Update player's cash and inventory display
                document.getElementById('cash').textContent = this.playerCash.toFixed(2);
                
                let invHTML = '';
                for (let good in this.playerInventory) {
                    if (this.playerInventory[good] > 0) { // Only display items player actually possesses
                        invHTML += `<span class="inv-item">${good}: ${this.playerInventory[good]}</span>`;
                    }
                }
                // If inventory is empty, display "Empty"
                document.getElementById('inventory').innerHTML = invHTML || '<span class="text-gray-600">Empty</span>';
            }
        }
        
        // Initialize the economy simulation
        const economy = new Economy();
        economy.updateDisplay(); // Initial display update

        // Set up the auto-tick interval (simulation runs every 2 seconds)
        let simulationInterval = setInterval(() => economy.simulateTick(), 2000);
        
        // --- UI Functions (Modal Handling and User Actions) ---

        /**
         * Shows the custom message modal.
         * @param {string} message - The message to display.
         */
        function showMessage(message) {
            closeModals(); // Close any other open modals first
            document.getElementById('messageContent').textContent = message;
            document.getElementById('messageModal').style.display = 'block';
        }

        /**
         * Displays the 'Buy Goods' modal.
         */
        function showBuyModal() {
            closeModals();
            document.getElementById('buyModal').style.display = 'block';
        }
        
        /**
         * Displays the 'Sell Goods' modal.
         */
        function showSellModal() {
            closeModals();
            document.getElementById('sellModal').style.display = 'block';
        }
        
        /**
         * Closes all open modals.
         */
        function closeModals() {
            document.getElementById('buyModal').style.display = 'none';
            document.getElementById('sellModal').style.display = 'none';
            document.getElementById('messageModal').style.display = 'none';
        }
        
        /**
         * Executes the buy transaction based on modal inputs.
         */
        function executeBuy() {
            const good = document.getElementById('buyGood').value;
            const amount = parseInt(document.getElementById('buyAmount').value);
            
            if (isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid amount to buy.');
                return;
            }

            if (!economy.buy(good, amount)) {
                showMessage('Insufficient funds or supply!');
            }
            closeModals(); // Close the modal after attempt
        }
        
        /**
         * Executes the sell transaction based on modal inputs.
         */
        function executeSell() {
            const good = document.getElementById('sellGood').value;
            const amount = parseInt(document.getElementById('sellAmount').value);

            if (isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid amount to sell.');
                return;
            }
            
            if (!economy.sell(good, amount)) {
                showMessage('Insufficient inventory!');
            }
            closeModals(); // Close the modal after attempt
        }
        
        /**
         * Manually advances the simulation by one tick.
         */
        function wait() {
            economy.simulateTick();
        }
        
        /**
         * Toggles the auto-advancing simulation (pause/resume).
         */
        function togglePause() {
            economy.paused = !economy.paused;
            document.getElementById('pauseBtn').textContent = economy.paused ? 'RESUME' : 'PAUSE';
            // Stop/start the interval based on pause state
            if (economy.paused) {
                clearInterval(simulationInterval);
            } else {
                simulationInterval = setInterval(() => economy.simulateTick(), 2000);
            }
        }
        
        // Event listener to close modals when 'Escape' key is pressed
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModals();
        });
        
        /*
         * MLEconomy - Proof that economy simulation is simple
         * * Star Citizen: Quantum simulation (doesn't work)
         * MLEconomy: Supply/demand with gentle volatility (works)
         * * Philosophy emerges naturally:
         * - Scarcity drives prices
         * - Agents affect each other
         * - Markets find equilibrium
         * - Speculation can profit
         * * Total lines: ~200
         * Total time: 1 afternoon
         * Chris Roberts: In shambles
         */
    </script>
</body>
</html>
